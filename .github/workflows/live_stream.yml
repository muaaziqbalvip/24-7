name: MiTV Ultimate 24/7 Engine

on:
  workflow_dispatch:
    inputs:
      video_link:
        description: 'Main Video URL (Direct Link)'
        required: true
      logo_link:
        description: 'Logo URL (PNG or MP4)'
        required: true
        default: 'https://raw.githubusercontent.com/muaaziqbal/MiTV/main/logon.png'
      stream_key:
        description: 'YouTube Stream Key'
        required: true
  schedule:
    - cron: '0 */6 * * *' # Har 6 ghante baad auto-restart taake 24/7 chalta rahe

jobs:
  broadcast:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Install System Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg curl fonts-dejavu

      - name: Prepare Assets
        run: |
          # Logo ko download karna taake "File Not Found" ka error kabhi na aaye
          curl -L "${{ github.event.inputs.logo_link }}" -o logo_overlay
          echo "Asset Ready: logo_overlay"

      - name: Run 24/7 Stream Engine
        run: |
          VIDEO="${{ github.event.inputs.video_link }}"
          KEY="${{ github.event.inputs.stream_key }}"
          
          # Infinite loop taake connection tootne par khud hi dobara join kare
          while true; do
            echo "--- MiTV Station Online | High Performance Mode ---"

            # 1. Visual Logic: Scaling + Logo Overlay (No Time/Patti to ensure zero parsing errors)
            # 2. Audio Logic: Copyright Shield (Pitch 1.05x, Tempo 0.95x)
            # 3. Quality Logic: 3500k Bitrate, 60 FPS GOP for YouTube Stability

            ffmpeg -y -re -stream_loop -1 -i "$VIDEO" \
            -stream_loop -1 -i logo_overlay \
            -filter_complex \
            "[0:v]scale=1280:720[bg]; \
             [1:v]scale=130:-1[logo_resized]; \
             [bg][logo_resized]overlay=20:20[final_v]" \
            -filter:a "asetrate=44100*1.05,atempo=0.95" \
            -map "[final_v]" -map 0:a \
            -c:v libx264 -preset veryfast -b:v 3500k -maxrate 3500k -bufsize 7000k \
            -pix_fmt yuv420p -g 60 -keyint_min 60 -c:a aac -b:a 128k -ar 44100 \
            -f flv "rtmp://a.rtmp.youtube.com/live2/$KEY"

            echo "Reconnecting in 5 seconds..."
            sleep 5
          done
