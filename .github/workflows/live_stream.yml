name: MiTV Ultimate 24/7 Engine (Full Logic)

on:
  workflow_dispatch:
    inputs:
      video_link:
        description: 'Main Video URL (Direct Link)'
        required: true
      audio_link:
        description: 'Custom Audio URL (Optional - Replaces Video Audio)'
        required: false
        default: ''
      logo_link:
        description: 'Logo URL (PNG or MP4)'
        required: true
        default: 'https://raw.githubusercontent.com/muaaziqbal/MiTV/main/logon.png'
      stream_key:
        description: 'YouTube Stream Key'
        required: true

  schedule:
    - cron: '0 */6 * * *' # Auto-restart logic every 6 hours

jobs:
  broadcast:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Install Media Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg curl fonts-dejavu

      - name: Prepare Assets
        run: |
          # Logo download logic taake "File Not Found" error na aaye
          curl -L "${{ github.event.inputs.logo_link }}" -o logo_overlay
          echo "Asset Ready: logo_overlay"

      - name: Run 24/7 Professional Stream
        run: |
          # Variables definition
          VIDEO="${{ github.event.inputs.video_link }}"
          AUDIO="${{ github.event.inputs.audio_link }}"
          KEY="${{ github.event.inputs.stream_key }}"
          
          # Infinite loop for 24/7 stability
          while true; do
            echo "--- MiTV Station Starting | Professional Mode ---"

            # ---------------------------------------------------------
            # FULL LOGIC FOR AUDIO & VIDEO INPUTS
            # ---------------------------------------------------------
            if [ -n "$AUDIO" ]; then
                echo "Custom Audio Detected. Combining Video + Custom Audio."
                # Scenario: Custom Audio provided (No pitch change needed for custom audio)
                INPUTS="-re -stream_loop -1 -i $VIDEO -re -i $AUDIO"
                A_FILTER="copy"
                AMAP="1:a"
            else
                echo "No Custom Audio. Using Original Audio with Copyright Protection."
                # Scenario: Original Audio (Apply Pitch 1.05x & Tempo 0.95x for Copyright Shield)
                INPUTS="-re -stream_loop -1 -i $VIDEO"
                A_FILTER="asetrate=44100*1.05,atempo=0.95"
                AMAP="0:a"
            fi

            # ---------------------------------------------------------
            # FFMPEG EXECUTION WITH DYNAMIC MAPPING
            # ---------------------------------------------------------
            # Logo Resizing & Overlay
            # High Quality Settings: 3500k Bitrate, 60 GOP
            
            ffmpeg -y $INPUTS \
            -stream_loop -1 -i logo_overlay \
            -filter_complex \
            "[0:v]scale=1280:720[bg]; \
             [2:v]scale=130:-1[logo_resized]; \
             [bg][logo_resized]overlay=20:20[final_v]" \
            -filter:a "$A_FILTER" \
            -map "[final_v]" -map $AMAP \
            -c:v libx264 -preset veryfast -b:v 3500k -maxrate 3500k -bufsize 7000k \
            -pix_fmt yuv420p -g 60 -c:a aac -b:a 128k -ar 44100 \
            -f flv "rtmp://a.rtmp.youtube.com/live2/$KEY"

            echo "Stream re-connecting in 5 seconds..."
            sleep 5
          done
