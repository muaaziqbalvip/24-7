name: MiTV_Pro_Global_Engine_v2

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'Direct MP4 Video Link'
        required: true
      audio_url:
        description: 'Direct Audio Link (Optional)'
        required: false
        default: ''
      stream_key:
        description: 'YouTube Stream Key'
        required: true

  schedule:
    - cron: '0 */6 * * *' # Har 6 ghante baad auto-restart for 24/7

jobs:
  run-stream:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Install Professional Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg curl fonts-noto-color-emoji fonts-nafees
          # Python dependencies for Firebase
          pip3 install requests pytz

      - name: Start MiTV Ultimate Engine
        env:
          FB_URL: "https://ramadan-2385b-default-rtdb.firebaseio.com"
          VIDEO: "${{ github.event.inputs.video_url }}"
          AUDIO: "${{ github.event.inputs.audio_url }}"
          KEY: "${{ github.event.inputs.stream_key }}"
          # Logo Image URL (Transparent PNG works best)
          LOGO_URL: "https://i.ibb.co/fzsgPwYG/2-1.png"
        run: |
          # 1. Download Logo locally to avoid network errors during filter execution
          curl -L "$LOGO_URL" -o mitv_logo.png
          
          # 2. Create the Python Engine
          cat << 'EOF' > engine.py
          import requests
          import time
          import os
          import subprocess

          VIDEO_IN = os.getenv('VIDEO')
          AUDIO_IN = os.getenv('AUDIO')
          STREAM_KEY = os.getenv('KEY')
          DATABASE_URL = os.getenv('FB_URL')
          LOGO = "mitv_logo.png"

          last_cmd_id = ""
          process = None

          def get_firebase_data():
              try:
                  r = requests.get(f"{DATABASE_URL}/streaming_control.json", timeout=10)
                  return r.json()
              except: return None

          while True:
              data = get_firebase_data()
              # Default settings if Firebase is down
              txt = "MiTV Network - Powered by Muaaz Iqbal"
              cmd_id = "1"
              
              if data:
                  txt = data.get('scroll_text', txt)
                  cmd_id = str(data.get('command_id', '1'))

              # Restart logic if command changes or process dies
              if cmd_id != last_cmd_id or (process and process.poll() is not None):
                  print(f"Update Detected: Starting Stream with Command ID {cmd_id}")
                  last_cmd_id = cmd_id
                  if process: 
                      process.terminate()
                      time.sleep(2)

                  # Audio Logic (Requirement: If no audio_url, use video audio with Copyright Pitch)
                  if not AUDIO_IN:
                      input_src = ["-re", "-stream_loop", "-1", "-i", VIDEO_IN]
                      a_filter = "asetrate=44100*1.05,atempo=0.95"
                      a_map = ["-map", "0:a"]
                  else:
                      input_src = ["-re", "-stream_loop", "-1", "-i", VIDEO_IN, "-re", "-i", AUDIO_IN]
                      a_filter = "copy"
                      a_map = ["-map", "1:a"]

                  # FFmpeg Filter Complex (Fixed Logo Corner + Professional Styling)
                  ffmpeg_cmd = [
                      "ffmpeg", "-y", *input_src, "-i", LOGO,
                      "-filter_complex",
                      "[0:v]scale=1280:720[bg];" # Main Scale
                      "[2:v]scale=120:-1[logo_resized];" # Logo Scale
                      "[bg][logo_resized]overlay=W-w-20:20[v1];" # Logo at Top Right Corner
                      "[v1]drawbox=x=20:y=20:w=180:h=60:color=black@0.5:t=fill[v2];" # Clock Box
                      "[v2]drawtext=text='%{localtime\\:%I\\\\\\:%M\\\\\\:%S %p}':x=35:y=35:fontsize=22:fontcolor=white[v3];" # Live Clock
                      "[v3]drawbox=y=ih-50:h=50:w=iw:color=0xD4AF37@0.9:t=fill[patti];" # Golden Patti
                      f"[patti]drawtext=text='{txt}':x=w-mod(t*100\\,w+tw):y=h-35:fontsize=26:fontcolor=black[final_v]",
                      "-map", "[final_v]", *a_map,
                      "-af", a_filter,
                      "-c:v", "libx264", "-preset", "ultrafast", "-b:v", "2500k", "-pix_fmt", "yuv420p",
                      "-g", "60", "-c:a", "aac", "-b:a", "128k", "-f", "flv",
                      f"rtmp://a.rtmp.youtube.com/live2/{STREAM_KEY}"
                  ]

                  os.environ['TZ'] = 'Asia/Karachi'
                  process = subprocess.Popen(ffmpeg_cmd)
              
              time.sleep(10)
          EOF
          
          python3 engine.py
